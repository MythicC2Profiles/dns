+++
title = "DNS"
chapter = false
weight = 5
+++

## Overview
This C2 Profile uses DNS requests to communicate between the agent and the C2 container, where messages are aggregated and forwarded to the Mythic API.
The DNS Requests use a format similar to the Sliver C2 Framework's DNS C2 (https://github.com/BishopFox/sliver/blob/master/server/c2/dns.go) and (https://sliver.sh/docs?name=DNS+C2).
However, Mythic's version is a bit different and slightly less complex (this is subject to change as this is currently in beta). To provide metadata about message transfers and ordering while still minimizing space, Mythic's DNS uses the following protobuf:
```protobuf
syntax = "proto3";
enum Actions {
  AgentToServer = 0;
  ServerToAgent = 1;
  ReTransmit = 2;
  MessageLost = 3;
}
message DnsPacket {
  Actions  Action       = 1;
  uint32 AgentSessionID = 2;
  uint32 MessageID      = 3;
  uint32 Size           = 4;
  uint32 Begin          = 5;
  string Data           = 6;
}
```
Agents will put a chunk of their normal base64 message in the "Data" field; this message is then marshalled and converted to base32 format (without padding). 
This resulting base32 message is what gets sent via a DNS Query message to the Mythic server.

Each request gets a reply with 4 answers in this order:
1. AgentSessionID
2. MessageID
3. Begin Byte Number
4. Action

The AgentSessionID is generated by the payload when it first executes and is a random uint32 value. This never changes and is NOT your Mythic UUIDs.
The MessageID is a random uint32 value generated by the payload _for each message_ that it's trying to send to Mythic (not each DnsPacket, but each normal Mythic message). 
The Begin value is the uint32 value of the where this set of Data chunks lives within the overall message being sent.
The Action indicates to the agent some context. When sending messages from Agent to Server, this will be AgentToServer for every message except for the last one where the server will reply with ServerToAgent to indicate that it got everything and Mythic has a reply.
A ReTransmit action asks the agent to stop and retransmit the entire message (all chunks) again - this typically means something happened on the DNS server side and it lost track of the message.
A MessageLost action happens when the agent is requesting a message from the server and typically happens if the server component restarts during message transmission. In this case, the server no longer has the message to send and the agent should consider it lost.

For example:
Sending a Mythic Checkin message will be the standard base64(uuid + message) format. That message is chunked up and put into a series of these DnsPacket objects.
The number of chunks depends on the length of the DNS domain being used. Let's assume there's two chunks with 100 Bytes of data in the first chunk and 50 Bytes in the second.
The agent would generate one MessageID, and that MessageID would be the same for both chunks. Size would be the total size, 150 Bytes for both messages. Begin for the first message would be 0, but would be 100 for the second.


### C2 Workflow
{{<mermaid>}}
sequenceDiagram
    
  
{{< /mermaid >}}

## Configuration Options
The profile reads a `config.json` file and binds to ports to receive DNS requests.

```JSON
{
  "instances": [
    {
      "port": 53,
      "debug": false,
      "bind_ip": "0.0.0.0",
      "domains": ["dns.localhost", "fake.localhost", "this.is.something.longer.localhost"]
    }
  ]
}


```

## Profile Options

#### domains
A list of domains to use for DNS Queries. The longer the domain, the less room there will be to transfer data.

#### killdate
Date for the agent to automatically exit, typically after an assessment is finished.

#### encrypted_exchange_check
True or False for if you want to perform a key exchange with the Mythic Server. When this is true, the agent uses the key specified by the base64 32Byte key to send an initial message to the Mythic server with a newly generated RSA public key. If this is set to `F`, then the agent tries to just use the base64 of the key as a static AES key for encryption. If that key is also blanked out, then the requests will all be in plaintext.

#### callback_interval
A number to indicate how many seconds the agent should wait in between tasking requests.

#### callback_jitter
Percentage of jitter effect for callback interval.

#### Domain Rotation
This indicates how you want your domains to be used (only really matters if you specify more than one domain). `fail-over` will use the first domain until it fails `failover_threshold` times, then it moves to the next one. `round-robin` will just keep using the next one in sequence for each message. `random` will just randomly use them.

#### AESPSK
Indicate if you want to use no crypto (i.e. plaintext) or if you want to use Mythic's aes256_hmac. Using no crypto is really helpful for agent development so that it's easier to see messages and get started faster, but for actual operations you should leave the default to aes256_hmac.

#### failover_threshold
How many times a domain should fail before moving on to the next domain when the domain rotation is `fail-over`.

#### dns_server
What is the DNS Server IP and Port (i.e: `8.8.8.8:53`) to use when issuing DNS requests.

#### record_type
What kinds of requests should the agent make and receive. A, AAAA, or TXT requests.

#### max_query_length
What is the maximum length of a query from the agent to Mythic. The hard limit is 255 by DNS protocol standards, but that could also stand out in environments. The smaller this number, the less data can be sent per request.

## Development



